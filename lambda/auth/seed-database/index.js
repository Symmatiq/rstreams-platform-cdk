"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const https = require("https");
const url = require("url");
const config = require("leo-config");
const env = process.env.LEO_ENVIRONMENT;
const resourcesJson = JSON.parse(process.env.Resources);
config.bootstrap({ [env]: { leoaws: resourcesJson } });
const leoAws = require("leo-aws");
const logger = require("leo-logger");
async function handler(event, _) {
    logger.log(event);
    function sendResponse(result) {
        return new Promise((resolve, reject) => {
            logger.log(result);
            var responseBody = JSON.stringify(result);
            var parsedUrl = url.parse(event.ResponseURL);
            var options = {
                hostname: parsedUrl.hostname,
                port: 443,
                path: parsedUrl.path,
                method: "PUT",
                headers: {
                    "content-type": "",
                    "content-length": responseBody.length,
                },
            };
            var request = https.request(options, function (response) {
                logger.log("Status code: " + response.statusCode);
                logger.log("Status message: " + response.statusMessage);
                resolve(result);
            });
            request.on("error", function (error) {
                logger.log("send(..) failed executing https.request(..): " + error);
                reject(error);
            });
            request.write(responseBody);
            request.end();
        });
    }
    process.on("uncaughtException", function (err) {
        logger.log("Got unhandled Exception");
        logger.log(err);
        return sendResponse({
            Status: "FAILED",
            Reason: "Uncaught Exception",
            PhysicalResourceId: event.PhysicalResourceId,
            StackId: event.StackId,
            RequestId: event.RequestId,
            LogicalResourceId: event.LogicalResourceId,
        });
    });
    event.PhysicalResourceId = "install";
    const steps = event.RequestType === "Create"
        ? [
            addIdentity({
                identity: "*",
                policy: "*",
            }).then(() => {
                return addPolicy({
                    name: "*",
                    statements: ['{"Effect": "Allow","Action": "*","Resource": "*"}'],
                });
            }),
        ]
        : [];
    logger.log("STEPS", steps);
    const sendRespPromise = Promise.all(steps)
        .then((foo) => {
        logger.log("Got success", foo);
        return sendResponse({
            Status: "SUCCESS",
            PhysicalResourceId: event.PhysicalResourceId,
            StackId: event.StackId,
            RequestId: event.RequestId,
            LogicalResourceId: event.LogicalResourceId,
        });
    })
        .catch((err) => {
        logger.log("Got error");
        logger.log(err);
        return sendResponse({
            Status: "FAILED",
            Reason: "it failed",
            PhysicalResourceId: event.PhysicalResourceId,
            StackId: event.StackId,
            RequestId: event.RequestId,
            LogicalResourceId: event.LogicalResourceId,
        });
    });
    sendRespPromise
        .then((resp) => {
        return resp;
    });
}
exports.handler = handler;
function addPolicy(policy) {
    return new Promise((resolve, reject) => {
        logger.log("Adding policy", leoAws.config.LeoAuthPolicy, policy);
        leoAws.dynamodb.update({
            TableName: leoAws.config.LeoAuthPolicy,
            Key: {
                name: policy.name,
            },
            UpdateExpression: "set statements  = :statements",
            ExpressionAttributeValues: {
                ":statements": policy.statements,
            },
        }, (err, data) => {
            if (err) {
                reject(err);
            }
            else {
                resolve(data);
            }
        });
    });
}
function addIdentity(identity) {
    return new Promise((resolve, reject) => {
        logger.log("Adding Identity", leoAws.config.LeoAuthIdentity, identity);
        leoAws.dynamodb.update({
            TableName: leoAws.config.LeoAuthIdentity,
            Key: {
                identity: identity.identity,
                policy: identity.policy,
            },
        }, (err, data) => {
            if (err) {
                reject(err);
            }
            else {
                resolve(data);
            }
        });
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxZQUFZLENBQUM7OztBQUViLE1BQU0sS0FBSyxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQztBQUMvQixNQUFNLEdBQUcsR0FBRyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7QUFFM0IsTUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLFlBQVksQ0FBQyxDQUFDO0FBQ3JDLE1BQU0sR0FBRyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsZUFBeUIsQ0FBQztBQUNsRCxNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsU0FBbUIsQ0FBQyxDQUFDO0FBQ2xFLE1BQU0sQ0FBQyxTQUFTLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxFQUFFLEVBQUUsTUFBTSxFQUFFLGFBQWEsRUFBRSxFQUFFLENBQUMsQ0FBQztBQUN2RCxNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7QUFDbEMsTUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLFlBQVksQ0FBQyxDQUFDO0FBbUM5QixLQUFLLFVBQVUsT0FBTyxDQUFDLEtBQVksRUFBRSxDQUFNO0lBQ2hELE1BQU0sQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUM7SUFFbEIsU0FBUyxZQUFZLENBQUMsTUFBZ0I7UUFDcEMsT0FBTyxJQUFJLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRTtZQUNyQyxNQUFNLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQ25CLElBQUksWUFBWSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDMUMsSUFBSSxTQUFTLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDLENBQUM7WUFDN0MsSUFBSSxP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YUFDYjtpQkFBTTtnQkFDTCxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7YUFDZjtRQUNILENBQUMsQ0FDRixDQUFDO0lBQ0osQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDO0FBRUQsU0FBUyxXQUFXLENBQUMsUUFBa0I7SUFDckMsT0FBTyxJQUFJLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRTtRQUNyQyxNQUFNLENBQUMsR0FBRyxDQUFDLGlCQUFpQixFQUFFLE1BQU0sQ0FBQyxNQUFNLENBQUMsZUFBZSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQ3ZFLE1BQU0sQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUNwQjtZQUNFLFNBQVMsRUFBRSxNQUFNLENBQUMsTUFBTSxDQUFDLGVBQWU7WUFDeEMsR0FBRyxFQUFFO2dCQUNILFFBQVEsRUFBRSxRQUFRLENBQUMsUUFBUTtnQkFDM0IsTUFBTSxFQUFFLFFBQVEsQ0FBQyxNQUFNO2FBQ3hCO1NBQ0YsRUFDRCxDQUFDLEdBQVUsRUFBRSxJQUFTLEVBQUUsRUFBRTtZQUN4QixJQUFJLEdBQUcsRUFBRTtnQkFDUCxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7YUFDYjtpQkFBTTtnQkFDTCxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7YUFDZjtRQUNILENBQUMsQ0FDRixDQUFDO0lBQ0osQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmNvbnN0IGh0dHBzID0gcmVxdWlyZShcImh0dHBzXCIpO1xuY29uc3QgdXJsID0gcmVxdWlyZShcInVybFwiKTtcblxuY29uc3QgY29uZmlnID0gcmVxdWlyZShcImxlby1jb25maWdcIik7XG5jb25zdCBlbnYgPSBwcm9jZXNzLmVudi5MRU9fRU5WSVJPTk1FTlQgYXMgc3RyaW5nO1xuY29uc3QgcmVzb3VyY2VzSnNvbiA9IEpTT04ucGFyc2UocHJvY2Vzcy5lbnYuUmVzb3VyY2VzIGFzIHN0cmluZyk7XG5jb25maWcuYm9vdHN0cmFwKHsgW2Vudl06IHsgbGVvYXdzOiByZXNvdXJjZXNKc29uIH0gfSk7XG5jb25zdCBsZW9Bd3MgPSByZXF1aXJlKFwibGVvLWF3c1wiKTtcbmNvbnN0IGxvZ2dlciA9IHJlcXVpcmUoXCJsZW8tbG9nZ2VyXCIpO1xuXG5leHBvcnQgaW50ZXJmYWNlIEV2ZW50IHtcbiAgUmVzcG9uc2VVUkw/OiBhbnk7XG4gIFBoeXNpY2FsUmVzb3VyY2VJZD86IGFueTtcbiAgU3RhY2tJZD86IGFueTtcbiAgUmVxdWVzdElkPzogYW55O1xuICBMb2dpY2FsUmVzb3VyY2VJZD86IGFueTtcbiAgUmVxdWVzdFR5cGU/OiBhbnk7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgUmVzcG9uc2Uge1xuICBTdGF0dXM6IHN0cmluZztcbiAgUmVhc29uPzogc3RyaW5nO1xuICBQaHlzaWNhbFJlc291cmNlSWQ6IGFueTtcbiAgU3RhY2tJZDogYW55O1xuICBSZXF1ZXN0SWQ6IGFueTtcbiAgTG9naWNhbFJlc291cmNlSWQ6IGFueTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBIdHRwUmVzcG9uc2Uge1xuICBzdGF0dXNDb2RlOiBzdHJpbmc7XG4gIHN0YXR1c01lc3NhZ2U6IHN0cmluZztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBQb2xpY3kge1xuICBuYW1lOiBzdHJpbmc7XG4gIHN0YXRlbWVudHM6IGFueTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBJZGVudGl0eSB7XG4gIGlkZW50aXR5OiBhbnk7XG4gIHBvbGljeTogUG9saWN5IHwgXCIqXCI7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBoYW5kbGVyKGV2ZW50OiBFdmVudCwgXzogYW55KSB7XG4gIGxvZ2dlci5sb2coZXZlbnQpO1xuXG4gIGZ1bmN0aW9uIHNlbmRSZXNwb25zZShyZXN1bHQ6IFJlc3BvbnNlKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGxvZ2dlci5sb2cocmVzdWx0KTtcbiAgICAgIHZhciByZXNwb25zZUJvZHkgPSBKU09OLnN0cmluZ2lmeShyZXN1bHQpO1xuICAgICAgdmFyIHBhcnNlZFVybCA9IHVybC5wYXJzZShldmVudC5SZXNwb25zZVVSTCk7XG4gICAgICB2YXIgb3B0aW9ucyA9IHtcbiAgICAgICAgaG9zdG5hbWU6IHBhcnNlZFVybC5ob3N0bmFtZSxcbiAgICAgICAgcG9ydDogNDQzLFxuICAgICAgICBwYXRoOiBwYXJzZWRVcmwucGF0aCxcbiAgICAgICAgbWV0aG9kOiBcIlBVVFwiLFxuICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgXCJjb250ZW50LXR5cGVcIjogXCJcIixcbiAgICAgICAgICBcImNvbnRlbnQtbGVuZ3RoXCI6IHJlc3BvbnNlQm9keS5sZW5ndGgsXG4gICAgICAgIH0sXG4gICAgICB9O1xuXG4gICAgICB2YXIgcmVxdWVzdCA9IGh0dHBzLnJlcXVlc3Qob3B0aW9ucywgZnVuY3Rpb24gKHJlc3BvbnNlOiBIdHRwUmVzcG9uc2UpIHtcbiAgICAgICAgbG9nZ2VyLmxvZyhcIlN0YXR1cyBjb2RlOiBcIiArIHJlc3BvbnNlLnN0YXR1c0NvZGUpO1xuICAgICAgICBsb2dnZXIubG9nKFwiU3RhdHVzIG1lc3NhZ2U6IFwiICsgcmVzcG9uc2Uuc3RhdHVzTWVzc2FnZSk7XG4gICAgICAgIHJlc29sdmUocmVzdWx0KTtcbiAgICAgIH0pO1xuXG4gICAgICByZXF1ZXN0Lm9uKFwiZXJyb3JcIiwgZnVuY3Rpb24gKGVycm9yOiBFcnJvcikge1xuICAgICAgICBsb2dnZXIubG9nKFwic2VuZCguLikgZmFpbGVkIGV4ZWN1dGluZyBodHRwcy5yZXF1ZXN0KC4uKTogXCIgKyBlcnJvcik7XG4gICAgICAgIHJlamVjdChlcnJvcik7XG4gICAgICB9KTtcbiAgICAgIHJlcXVlc3Qud3JpdGUocmVzcG9uc2VCb2R5KTtcbiAgICAgIHJlcXVlc3QuZW5kKCk7XG4gICAgfSk7XG4gIH1cblxuICBwcm9jZXNzLm9uKFwidW5jYXVnaHRFeGNlcHRpb25cIiwgZnVuY3Rpb24gKGVycikge1xuICAgIGxvZ2dlci5sb2coXCJHb3QgdW5oYW5kbGVkIEV4Y2VwdGlvblwiKTtcbiAgICBsb2dnZXIubG9nKGVycik7XG4gICAgcmV0dXJuIHNlbmRSZXNwb25zZSh7XG4gICAgICBTdGF0dXM6IFwiRkFJTEVEXCIsXG4gICAgICBSZWFzb246IFwiVW5jYXVnaHQgRXhjZXB0aW9uXCIsXG4gICAgICBQaHlzaWNhbFJlc291cmNlSWQ6IGV2ZW50LlBoeXNpY2FsUmVzb3VyY2VJZCxcbiAgICAgIFN0YWNrSWQ6IGV2ZW50LlN0YWNrSWQsXG4gICAgICBSZXF1ZXN0SWQ6IGV2ZW50LlJlcXVlc3RJZCxcbiAgICAgIExvZ2ljYWxSZXNvdXJjZUlkOiBldmVudC5Mb2dpY2FsUmVzb3VyY2VJZCxcbiAgICB9KTtcbiAgfSk7XG5cbiAgZXZlbnQuUGh5c2ljYWxSZXNvdXJjZUlkID0gXCJpbnN0YWxsXCI7XG4gIGNvbnN0IHN0ZXBzID1cbiAgICBldmVudC5SZXF1ZXN0VHlwZSA9PT0gXCJDcmVhdGVcIlxuICAgICAgPyBbXG4gICAgICAgICAgYWRkSWRlbnRpdHkoe1xuICAgICAgICAgICAgaWRlbnRpdHk6IFwiKlwiLFxuICAgICAgICAgICAgcG9saWN5OiBcIipcIixcbiAgICAgICAgICB9KS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgIHJldHVybiBhZGRQb2xpY3koe1xuICAgICAgICAgICAgICBuYW1lOiBcIipcIixcbiAgICAgICAgICAgICAgc3RhdGVtZW50czogWyd7XCJFZmZlY3RcIjogXCJBbGxvd1wiLFwiQWN0aW9uXCI6IFwiKlwiLFwiUmVzb3VyY2VcIjogXCIqXCJ9J10sXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9KSxcbiAgICAgICAgXVxuICAgICAgOiBbXTtcblxuICBsb2dnZXIubG9nKFwiU1RFUFNcIiwgc3RlcHMpO1xuICBjb25zdCBzZW5kUmVzcFByb21pc2UgPSBQcm9taXNlLmFsbChzdGVwcylcbiAgICAudGhlbigoZm9vKSA9PiB7XG4gICAgICBsb2dnZXIubG9nKFwiR290IHN1Y2Nlc3NcIiwgZm9vKTtcbiAgICAgIHJldHVybiBzZW5kUmVzcG9uc2Uoe1xuICAgICAgICBTdGF0dXM6IFwiU1VDQ0VTU1wiLFxuICAgICAgICBQaHlzaWNhbFJlc291cmNlSWQ6IGV2ZW50LlBoeXNpY2FsUmVzb3VyY2VJZCxcbiAgICAgICAgU3RhY2tJZDogZXZlbnQuU3RhY2tJZCxcbiAgICAgICAgUmVxdWVzdElkOiBldmVudC5SZXF1ZXN0SWQsXG4gICAgICAgIExvZ2ljYWxSZXNvdXJjZUlkOiBldmVudC5Mb2dpY2FsUmVzb3VyY2VJZCxcbiAgICAgIH0pO1xuICAgIH0pXG4gICAgLmNhdGNoKChlcnIpID0+IHtcbiAgICAgIGxvZ2dlci5sb2coXCJHb3QgZXJyb3JcIik7XG4gICAgICBsb2dnZXIubG9nKGVycik7XG4gICAgICByZXR1cm4gc2VuZFJlc3BvbnNlKHtcbiAgICAgICAgU3RhdHVzOiBcIkZBSUxFRFwiLFxuICAgICAgICBSZWFzb246IFwiaXQgZmFpbGVkXCIsXG4gICAgICAgIFBoeXNpY2FsUmVzb3VyY2VJZDogZXZlbnQuUGh5c2ljYWxSZXNvdXJjZUlkLFxuICAgICAgICBTdGFja0lkOiBldmVudC5TdGFja0lkLFxuICAgICAgICBSZXF1ZXN0SWQ6IGV2ZW50LlJlcXVlc3RJZCxcbiAgICAgICAgTG9naWNhbFJlc291cmNlSWQ6IGV2ZW50LkxvZ2ljYWxSZXNvdXJjZUlkLFxuICAgICAgfSk7XG4gICAgfSk7XG4gIHNlbmRSZXNwUHJvbWlzZVxuICAgIC50aGVuKChyZXNwKSA9PiB7XG4gICAgICByZXR1cm4gcmVzcDtcbiAgICB9KVxufVxuXG5mdW5jdGlvbiBhZGRQb2xpY3kocG9saWN5OiBQb2xpY3kpOiBQcm9taXNlPGFueT4ge1xuICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIGxvZ2dlci5sb2coXCJBZGRpbmcgcG9saWN5XCIsIGxlb0F3cy5jb25maWcuTGVvQXV0aFBvbGljeSwgcG9saWN5KTtcbiAgICBsZW9Bd3MuZHluYW1vZGIudXBkYXRlKFxuICAgICAge1xuICAgICAgICBUYWJsZU5hbWU6IGxlb0F3cy5jb25maWcuTGVvQXV0aFBvbGljeSxcbiAgICAgICAgS2V5OiB7XG4gICAgICAgICAgbmFtZTogcG9saWN5Lm5hbWUsXG4gICAgICAgIH0sXG4gICAgICAgIFVwZGF0ZUV4cHJlc3Npb246IFwic2V0IHN0YXRlbWVudHMgID0gOnN0YXRlbWVudHNcIixcbiAgICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczoge1xuICAgICAgICAgIFwiOnN0YXRlbWVudHNcIjogcG9saWN5LnN0YXRlbWVudHMsXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgICAgKGVycjogRXJyb3IsIGRhdGE6IGFueSkgPT4ge1xuICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmVzb2x2ZShkYXRhKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICk7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBhZGRJZGVudGl0eShpZGVudGl0eTogSWRlbnRpdHkpOiBQcm9taXNlPGFueT4ge1xuICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIGxvZ2dlci5sb2coXCJBZGRpbmcgSWRlbnRpdHlcIiwgbGVvQXdzLmNvbmZpZy5MZW9BdXRoSWRlbnRpdHksIGlkZW50aXR5KTtcbiAgICBsZW9Bd3MuZHluYW1vZGIudXBkYXRlKFxuICAgICAge1xuICAgICAgICBUYWJsZU5hbWU6IGxlb0F3cy5jb25maWcuTGVvQXV0aElkZW50aXR5LFxuICAgICAgICBLZXk6IHtcbiAgICAgICAgICBpZGVudGl0eTogaWRlbnRpdHkuaWRlbnRpdHksXG4gICAgICAgICAgcG9saWN5OiBpZGVudGl0eS5wb2xpY3ksXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgICAgKGVycjogRXJyb3IsIGRhdGE6IGFueSkgPT4ge1xuICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmVzb2x2ZShkYXRhKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICk7XG4gIH0pO1xufVxuIl19